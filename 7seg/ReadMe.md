# 7セグメントLEDを使ってみよう

## 本練習の目的

- 7セグにデータを表示する
- シフトレジスタを使ってみる
- 乱数の扱い

## 実装内容

仕様：数字を高速で表示して、ボタンを押したら0~9までの数字をランダムに表示して止める。再びボタンを押されたら最初に戻る。

## 7セグのピンとLEDの対応

a ~ g までの7つのLEDと、dpのLED合わせて8個のLEDで数字を表すLED。

<image src="7seg-pin.png">

例：0 を表示したい場合には、a ~ f までを1、gに0を設定するとデジタル数字の0となります。

0 ~ 9 のON/OFFの設定サンプル

```python
# a, b, c, d, e, f, g, dp,
DIGITS = {
    '0': [1, 1, 1, 1, 1, 1, 0, 0],
    '1': [0, 1, 1, 0, 0, 0, 0, 0],
    '2': [1, 1, 0, 1, 1, 0, 1, 0],
    '3': [1, 1, 1, 1, 0, 0, 1, 0],
    '4': [0, 1, 1, 0, 0, 1, 1, 0],
    '5': [1, 0, 1, 1, 0, 1, 1, 0],
    '6': [1, 0, 1, 1, 1, 1, 1, 0],
    '7': [1, 1, 1, 0, 0, 0, 0, 0],
    '8': [1, 1, 1, 1, 1, 1, 1, 0],
    '9': [1, 1, 1, 1, 0, 1, 1, 0],
}
```

## 単純な接続のサンプル

配線の数は少ないが、ESP32の出力PINを8本使うので、ESP32で出来ることが減ってしまう。

<image src="7seg-direct.png" width="400px">

## 以下を実行して結果を確認してみましょう

乱数を発生させてみよう。

```python
import random

# 0〜9の乱数を生成
random_number = random.randint(0, 9)
print(random_number)
```

１セグメントずつ光らせてみよう。

```python
from machine import Pin

# GPIOピンアサイン
# a=4, b=5, c=12, d=13, e=14, f=18, g=19, dp=25
PIN_ASSIGIN = [4, 5, 12, 13, 14, 18, 19, 25]

for pin_no in PIN_ASSIGIN:
    print(f'PIN:{pin_no}')
    pin = Pin(pin_no, Pin.OUT)
    pin.value(1)
    time.sleep(0.5)
    pin.value(0)
```

数字を表示してみよう

```python
from machine import Pin

# GPIOピンアサイン
# a=4, b=5, c=12, d=13, e=14, f=18, g=19, dp=25
PIN_ASSIGIN = [4, 5, 12, 13, 14, 18, 19, 25]
# 3を表示する値の一覧
PIN_VALUES = [1, 1, 1, 1, 0, 0, 1, 0]

# zipは、ループを回す際にセットで取り扱ってくれる
for pin_no, value in zip(PIN_ASSIGIN, PIN_VALUES):
    pin = Pin(pin_no, Pin.OUT)
    pin.value(value)
```

## シフトレジスタ

シフトレジスタは、デジタル回路で使われる記憶装置の一種で、データをビット単位で順次移動させることができるものです。今回はシリアルデータをパラレルデータに変換するパラレル出力のものを利用します。

<image src="74HC595.png" width="400px">

| PIN | NOTE |
| --- | --- |
| VCC | 電圧供給 |
| SER | データ入力 |
| OE | LOWで出力有効(GND) |
| RCLK | ラッチ |
| SRCLK | クロック |
| SRCLR | データクリア（HIGHにしておく） |
| QH' | カスケード用シリアル出力 |
| GND | グラウンド |
| QA~QH | 出力 |

以下の手順でシフトレジスタに指令を送ると、8個のピンに出力を設定できます。

1. ラッチをOFFにしてデータを準備する
2. 1 ~ 8 まで順にループする
3. クロックピンをオフにする
4. データピンをオンもしくはオフにする
5. クロックピンをオンにして、データを設定する
6. 2から繰り返す
7. ラッチをONにしてデータを反映する

## シフトレジスタを利用した接続のサンプル

配線は複雑になるが、シフトレジスタを利用することでESP32の出力は3本で済みます。

```text
ESP32 GPIO -----> DS (74HC595)
ESP32 GPIO -----> SH_CP (74HC595)
ESP32 GPIO -----> ST_CP (74HC595)

74HC595 -> 7seg
  Q0 ----[220Ω]-----> a
  Q1 ----[220Ω]-----> b
  Q2 ----[220Ω]-----> c
  Q3 ----[220Ω]-----> d
  Q4 ----[220Ω]-----> e
  Q5 ----[220Ω]-----> f
  Q6 ----[220Ω]-----> g
  Q7 ---------------> dp
```

<image src="7seg.png" width="400px">
